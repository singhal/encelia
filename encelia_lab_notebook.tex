%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Daily Laboratory Book
% LaTeX Template
%
% This template has been downloaded from:
% http://www.latextemplates.com
%
% Original author:
% Frank Kuster (http://www.ctan.org/tex-archive/macros/latex/contrib/labbook/)
%
% Important note:
% This template requires the labbook.cls file to be in the same directory as the
% .tex file. The labbook.cls file provides the necessary structure to create the
% lab book.
%
% The \lipsum[#] commands throughout this template generate dummy text
% to fill the template out. These commands should all be removed when 
% writing lab book content.
%
% HOW TO USE THIS TEMPLATE 
% Each day in the lab consists of three main things:
%
% 1. LABDAY: The first thing to put is the \labday{} command with a date in 
% curly brackets, this will make a new page and put the date in big letters 
% at the top.
%
% 2. EXPERIMENT: Next you need to specify what experiment(s) you are 
% working on with an \experiment{} command with the experiment shorthand 
% in the curly brackets. The experiment shorthand is defined in the 
% 'DEFINITION OF EXPERIMENTS' section below, this means you can 
% say \experiment{pcr} and the actual text written to the PDF will be what 
% you set the 'pcr' experiment to be. If the experiment is a one off, you can 
% just write it in the bracket without creating a shorthand. Note: if you don't 
% want to have an experiment, just leave this out and it won't be printed.
%
% 3. CONTENT: Following the experiment is the content, i.e. what progress 
% you made on the experiment that day.
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%----------------------------------------------------------------------------------------
%	PACKAGES AND OTHER DOCUMENT CONFIGURATIONS
%----------------------------------------------------------------------------------------

\documentclass[idxtotoc,hyperref,openany,oneside]{labbook} % 'openany' here removes the gap page between days, erase it to restore this gap; 'oneside' can also be added to remove the shift that odd pages have to the right for easier reading

\usepackage[ 
  backref=page,
  pdfpagelabels=true,
  plainpages=false,
  colorlinks=true,
  bookmarks=true,
  pdfview=FitB]{hyperref} % Required for the hyperlinks within the PDF
  
\usepackage{booktabs} % Required for the top and bottom rules in the table
\usepackage{float} % Required for specifying the exact location of a figure or table
\usepackage{graphicx} % Required for including images
\usepackage{mathpazo} % add possibly `sc` and `osf` options
\usepackage{eulervm}

\newcommand{\HRule}{\rule{\linewidth}{0.5mm}} % Command to make the lines in the title page
\setlength\parindent{0pt} % Removes all indentation from paragraphs

%----------------------------------------------------------------------------------------
%	DEFINITION OF EXPERIMENTS
%----------------------------------------------------------------------------------------

\newexperiment{variants}{Variant Calling}

%---------------------------------------------------------------------------------------

\begin{document}

%----------------------------------------------------------------------------------------
%	TITLE PAGE
%----------------------------------------------------------------------------------------

\frontmatter % Use Roman numerals for page numbers
\title{
\begin{center}
\HRule \\[0.4cm]
{\Huge \bfseries Lab Notebook \\[0.5cm] \Large Encelia Research}\\[0.4cm] % Degree
\HRule \\[1.5cm]
\end{center}
}
\author{\Huge Sonal Singhal \\ \\ \LARGE sonal.singhal1@gmail.com \\[2cm]} % Your name and email address
\date{Beginning 6 October 2014} % Beginning date
\maketitle

\tableofcontents

\mainmatter % Use Arabic numerals for page numbers

%----------------------------------------------------------------------------------------
%	LAB BOOK CONTENTS
%----------------------------------------------------------------------------------------

% Blank template to use for new days:

%\labday{Day, Date Month Year}

%\experiment{}

%Text

%-----------------------------------------

%\experiment{}

%Text

%----------------------------------------------------------------------------------------

\labday{Monday, 6 October 2014}

\experiment{variants}
GATK did a horrible job generating variants, and it was very very slow. So, all future work comparing variants will be just comparing Samtools (as generated by BWA and Bowtie) with Platypus (as generated by BWA and Bowtie). In general, it looks like Platypus generates more variants, so Samtools might be the more conservative set. \\

I will want to compare the number of variants found and the genotypes called. \\

\labday{Tuesday, 7 October 2014}
\experiment{variants}
I wanted to get average coverage across the entire contig for each contig for each assembly. I did this by writing the script \verb+get_depth.py+, which is a simple wrapper around the \verb+samtools depth+ script. I calculated depths using the BWA-generated BAM files. For population genomics analyses, I will drop any contigs which have lower than 5$\times$ coverage, though I suspect not many annotated contigs will have that low of coverage.

\labday{Wednesday, 8 October 2014}
\experiment{variants}
In order to do population genomics between \emph{E. palmeri} and \emph{E. ventorum}, I am going to align reads from both populations to the same reference. I decided to use \emph{E. palmeri} because it seemed marginally more complete. I modified the alignment script to do this, and it is called \verb+5alignment_bwa_sameref.py+. All BAM files from this analysis will be called \verb+*sameref*+.

\labday{Thursday, 9 October 2014}
\experiment{variants}
I did some tests comparing Bowtie / BWA for alignment and Platypus / GATK / Samtools for variant calling.
\begin{itemize}
\item Bowtie / samtools (which had been my go to) does really poorly!
\item Anything with GATK is a joke -- misses so many really good variants.
\item Anything with Platypus seems to find a lot of spurious variants.
\item BWA / samtools looks like the new best pipeline. 
\end{itemize}

But, it weirded me out that there is such seeming inconsistency across the alignment and variant callers for SNPs found. So I did a few things.
\begin{itemize}
\item Looked at if there is more consistency when depth is high. There is, but it is marginal.
\item Looked at if there is more consistency when contigs are annotated. There is, but it is marginal.
\item Looked at if depth is connected to annotation, and yes, annotated contigs need to have higher depth.
\item Looked at the filter values for SNPs in the winning approach (bwa / samtools) and compared values across SNPs that were good (i.e., found in another variant call for the same raw data) or bad (i.e., unique to the given set).
\begin{itemize}
\item looks like the only filter worth considering is MQ, or mapping quality
\item note that 24991 are bad
\item note that 113730 are good
\item getting rid of SNPS that are MQ $<=$ 20 will lose very few real SNPs likely, so the only filter worth considering
\end{itemize}
\end{itemize}
These analyses are all on my desktop, under \verb+/Users/singhal/encelia/analyses/coverage_snp/+ and \verb+/Users/singhal/encelia/analyses/snp_analysis/+.

\labday{Monday, 13 October 2014 - Friday, 17 October 2014}
\begin{enumerate}
\item Read Backed Phasing: read backed phasing didn't really appear to work; maybe because didn't build on haplotypecaller? don't want to use haplotypecaller because that's not trustworthy, so no phasing, I guess.
\item Sequence Divergence: estimated $D_xy$ and $D_a$ for Encelia palmeri and ventorum. Results are plotted locally under analysis. 0.76\%: average Da, 0.97\%: average Dxy
\item Ancestral allele: made massive mpileup file that I will parse later to create the ancestral sequence for use in ANGSD. Run via: \verb+samtools mpileup -f ~/encelia/annotation/palmeri.annotated.fasta CD101.bwa_sameref.bam CD102.bwa_sameref.bam CD103.bwa_sameref.bam CD104.bwa_sameref.bam > ancestral_allele.mpileup.out+
\item SNP calls: redid them, because it became clear that the mapping filter was too stringtent. So, I redid them with no BAQ and no adjustments for mapping quality. I am still concerned about these results, because definitely gets some SNPs that aren't legit, which can be easily seen as the sites that are uniformly heterozygous. Need to revisit this, though I did end up using these results for the pop genomic stuff. I think these SNP calls are okay depending on what I am trying to do.
\item SNP Filtering 1: Looked at the filter values for SNPs in the winning approach (bwa / samtools) and compared values across SNPs that were good (i.e., found in another variant call for the same raw data) or bad (i.e., unique to the given set).
\begin{itemize}
\item looks like the only filter worth considering is MQ, or mapping quality
\item note that 57458 are bad
\item note that 48829 are good
\item getting rid of SNPS
\begin{enumerate} 
\item MQSB - filter less than 0.2 
\item SGB - filter less than -500 
\item MQ0F - filter greater than 0.2 
\item MQ - filter less than 40 
\end{enumerate}
\item using these filters, will lose very few real SNPs likely
\item gives: 121399: fixed SNPs, 78691: shared SNPs, 111270: polymorphic SNPs in palmeri, 63069: polymorphic SNPS in ventorum
\end{itemize}
\item Admixture: best result was 2 populations, no evidence for admixture
\item SNP Filtering 2: To filter for coverage, did the following:
\begin{verbatim}
~/bin/bedtools2/bin/bedtools intersect -a ../variants/Encelia_palmeri.bwa_sameref.samtools.annotated.filteredSNPs.vcf -b popgenomics.bed -sorted > Encelia_palmeri.bwa_sameref.samtools.annotated.filteredSNPs.highCoverage.vcf
~/bin/bedtools2/bin/bedtools intersect -a ../variants/Encelia_ventorum.bwa_sameref.samtools.annotated.filteredSNPs.vcf -b popgenomics.bed -sorted > Encelia_ventorum.bwa_sameref.samtools.annotated.filteredSNPs.highCoverage.vcf
\end{verbatim}
\end{enumerate}
\end{document}